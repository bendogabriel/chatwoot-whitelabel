# White-Label Template Configuration System

**Automated client configuration generator for Nexa AI Platform**

---

## Overview

This system automates the creation of deployment configurations for new clients. Instead of manually editing `.env` files and docker-compose, simply fill in a YAML template and generate everything automatically.

## Quick Start

### 1. Create Client Configuration

```bash
# Copy template
cp templates/client-config.template.yml clients/acme-corp.yml

# Edit with client details
nano clients/acme-corp.yml
```

### 2. Generate Deployment Files

```bash
# Run generator
python scripts/generate-client-config.py clients/acme-corp.yml

# Output:
# ✅ Generated: generated/acme-corp/.env
# ✅ Generated: generated/acme-corp/DNS-CONFIG.md
# ✅ Generated: generated/acme-corp/DEPLOYMENT-CHECKLIST.md
# ✅ Generated: generated/acme-corp/README.md
```

### 3. Deploy

```bash
# Follow generated checklist
cd generated/acme-corp
cat DEPLOYMENT-CHECKLIST.md

# Upload to server
scp -r . root@server-ip:/opt/nexa-platform/
```

---

## Template Structure

### Client Information

```yaml
client:
  id: acme-corp              # Unique ID (lowercase, no spaces)
  name: "Acme Corp"          # Display name
  domain: acme-corp.com      # Primary domain
  contact:
    name: "Jane Doe"
    email: "jane@acme-corp.com"
```

**ID requirements:**
- Lowercase letters, numbers, hyphens only
- No spaces or special characters
- Used in: Docker container names, file paths, database names

### Branding

```yaml
branding:
  name: "Acme Support"
  logo:
    url: "https://acme-corp.com/logo.svg"
  colors:
    primary: "#007bff"       # Hex color code
```

**Logo requirements:**
- SVG format (recommended) or PNG
- Publicly accessible URL or CDN
- Size: 200x50px (approximate)

**Color format:**
- Hex code with `#` prefix
- Used in: UI buttons, links, email templates

### Domains

```yaml
domains:
  inbox: inbox.acme-corp.com
  atlas: atlas.acme-corp.com
  dashboard: dashboard.acme-corp.com
  n8n: n8n.acme-corp.com
```

**Requirements:**
- Must be subdomains of client's domain
- DNS A records must point to server IP
- SSL certificates auto-generated by Traefik

### Email (SMTP)

```yaml
email:
  smtp:
    host: smtp.gmail.com
    port: 587
    username: noreply@acme-corp.com
  from:
    name: "Acme Support"
    email: noreply@acme-corp.com
```

**Gmail setup:**
1. Enable 2FA on Google account
2. Generate App Password: https://myaccount.google.com/apppasswords
3. Use app password in `.env` (not in YAML template)

### AI Configuration

```yaml
ai:
  qualification:
    threshold: 7             # Score 1-10 for handoff to human
    auto_handoff: true       # Auto-create Chatwoot conversation
  openai:
    model: gpt-4-turbo-preview
```

**Threshold guide:**
- 1-3: Very loose (most leads go to humans)
- 4-6: Moderate (balanced)
- 7-9: Strict (only hot leads to humans)
- 10: Very strict (almost no handoffs)

### Feature Flags

```yaml
features:
  enable_account_signup: false    # Security: disable public signup
  enable_voice: false             # ElevenLabs voice messages
  enable_analytics: true          # Dashboard metrics
```

---

## Generated Files

### `.env`

Environment variables for Docker Compose deployment.

**Includes:**
- Auto-generated secrets (PostgreSQL, Redis, JWT, etc.)
- Client branding variables
- Domain configuration
- Placeholders for manual secrets (API keys)

**⚠️ Security:**
- Contains sensitive credentials
- Never commit to Git
- Store in password manager (1Password, Bitwarden)
- Encrypt before sending to team

### `DNS-CONFIG.md`

DNS records to configure with client's DNS provider.

**Includes:**
- A records for all subdomains
- Verification commands
- Cloudflare-specific notes

### `DEPLOYMENT-CHECKLIST.md`

Step-by-step deployment guide with checkboxes.

**Covers:**
- Server provisioning
- Docker installation
- File upload
- Service startup
- Initial configuration
- Client handoff

### `README.md`

Overview and quick reference for deployment.

---

## Advanced Usage

### Custom Docker Images

If client needs custom branding beyond ENV variables:

1. **Build client-specific image:**
   ```bash
   cd chatwoot-custom
   BRAND_NAME="Acme Support" \
   PRIMARY_COLOR="#007bff" \
   ./scripts/build-custom-image.sh v3.15.0-acme
   ```

2. **Update template:**
   ```yaml
   deployment:
     docker_images:
       chatwoot: nexateam/chatwoot-custom:v3.15.0-acme
   ```

3. **Regenerate config:**
   ```bash
   python scripts/generate-client-config.py clients/acme-corp.yml
   ```

### Multi-Environment Setup

Create separate configs for staging/production:

```bash
# Staging
cp clients/acme-corp.yml clients/acme-corp-staging.yml
# Edit domains: staging-inbox.acme-corp.com

# Production
# Keep clients/acme-corp.yml as-is

# Generate both
python scripts/generate-client-config.py clients/acme-corp-staging.yml
python scripts/generate-client-config.py clients/acme-corp.yml
```

### Bulk Generation

Generate configs for multiple clients:

```bash
for config in clients/*.yml; do
    echo "Generating: $config"
    python scripts/generate-client-config.py "$config"
done
```

---

## Workflow

### New Client Onboarding

**1. Sales closes deal**
- Collect: company name, domain, contact info, branding

**2. Create configuration**
```bash
cp templates/client-config.template.yml clients/new-client.yml
nano clients/new-client.yml
# Fill in all fields
```

**3. Generate deployment files**
```bash
python scripts/generate-client-config.py clients/new-client.yml
```

**4. Review & validate**
```bash
cd generated/new-client
cat .env                        # Verify branding
cat DNS-CONFIG.md              # Send to client for DNS setup
cat DEPLOYMENT-CHECKLIST.md   # Review steps
```

**5. Fill in secrets**
```bash
nano .env
# Add:
# - SMTP_PASSWORD (Gmail app password)
# - OPENAI_API_KEY
# - WHATSAPP_API_KEY
# Save to password manager
```

**6. Deploy**
```bash
# Follow DEPLOYMENT-CHECKLIST.md
# Or use automated script (future):
./deploy.sh generated/new-client <server-ip>
```

**7. Handoff to client**
- Send credentials via secure channel
- Schedule training call
- Add to monitoring

---

## Directory Structure

```
nexa-platform/
├── templates/
│   ├── README.md (this file)
│   └── client-config.template.yml
├── clients/                        # Git-ignored (contains client data)
│   ├── acme-corp.yml
│   ├── globex.yml
│   └── initech.yml
├── generated/                      # Git-ignored (contains secrets)
│   ├── acme-corp/
│   │   ├── .env
│   │   ├── DNS-CONFIG.md
│   │   ├── DEPLOYMENT-CHECKLIST.md
│   │   └── README.md
│   └── globex/
│       └── ...
└── scripts/
    └── generate-client-config.py
```

**⚠️ Important:**
- `clients/` and `generated/` are in `.gitignore`
- Never commit client configurations or secrets
- Back up securely (encrypted, password manager)

---

## Troubleshooting

### Generator fails with "Missing required field"

**Problem:** YAML template incomplete

**Fix:**
```bash
# Validate YAML syntax
python -c "import yaml; yaml.safe_load(open('clients/client.yml'))"

# Check required fields
grep -E "^(client|branding|domains|email):" clients/client.yml
```

### Generated .env has empty secrets

**Expected behavior:** Some secrets must be filled manually for security

**Manual secrets required:**
- `SMTP_PASSWORD` - Gmail app password
- `OPENAI_API_KEY` - OpenAI API key
- `WHATSAPP_API_KEY` - WhatsApp API credentials
- `CHATWOOT_API_TOKEN` - Generated after first Chatwoot login

### Client wants different branding per environment

**Solution:** Create multiple configs

```bash
# Production
clients/acme-corp.yml
# branding.name: "Acme Support"

# Staging
clients/acme-corp-staging.yml
# branding.name: "Acme Support [STAGING]"
# branding.colors.primary: "#ff9900"  # Orange for staging
```

---

## Best Practices

### Security

- ✅ **DO:** Store generated `.env` in password manager
- ✅ **DO:** Use strong, unique secrets per client
- ✅ **DO:** Encrypt before sharing with team
- ❌ **DON'T:** Commit client configs to Git
- ❌ **DON'T:** Reuse secrets across clients
- ❌ **DON'T:** Send `.env` via email/Slack unencrypted

### Organization

- ✅ **DO:** Use consistent client ID format (lowercase-hyphen)
- ✅ **DO:** Keep template up-to-date with latest features
- ✅ **DO:** Document custom configurations in YAML comments
- ❌ **DON'T:** Mix staging/production in same config
- ❌ **DON'T:** Delete client configs after deployment (archive instead)

### Automation

For 10+ clients, consider automating:

1. **Terraform for infrastructure:**
   ```hcl
   resource "digitalocean_droplet" "client" {
     name   = var.client_name
     size   = "s-2vcpu-4gb"
     region = "nyc3"
   }
   ```

2. **Ansible for deployment:**
   ```yaml
   - name: Deploy Nexa Platform
     hosts: "{{ client_name }}"
     tasks:
       - name: Upload config files
       - name: Start Docker Compose
   ```

3. **CI/CD pipeline:**
   - GitHub Actions to validate client configs
   - Auto-deploy on merge to `main`

---

## Next Steps

1. **Create your first client config:**
   ```bash
   cp templates/client-config.template.yml clients/test-client.yml
   python scripts/generate-client-config.py clients/test-client.yml
   ```

2. **Test deployment locally:**
   ```bash
   cd generated/test-client
   # Use local server or DigitalOcean test droplet
   ```

3. **Document customizations:**
   - Add notes to client YAML
   - Update this README with learnings

4. **Automate further:**
   - See `docs/06-AUTOMATION.md` (future)
   - Terraform + Ansible examples

---

**Questions?** Contact Nexa Team: support@nexateam.com.br
