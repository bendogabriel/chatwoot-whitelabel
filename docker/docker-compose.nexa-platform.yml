version: "3.7"

# Nexa AI Platform - Unified Stack
# Components: Chatwoot (white-label) + Atlas Nexa (AI SDR) + Dashboard
# Shared: PostgreSQL (pgvector) + Redis

networks:
  nexa_network:
    driver: bridge
    name: nexa_network

volumes:
  postgres_data:
    name: nexa_postgres_data
  redis_data:
    name: nexa_redis_data
  chatwoot_storage:
    name: nexa_chatwoot_storage
  atlas_storage:
    name: nexa_atlas_storage

services:
  # ==========================================
  # SHARED INFRASTRUCTURE
  # ==========================================

  postgres:
    image: pgvector/pgvector:pg16
    container_name: nexa_postgres
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - TZ=America/Sao_Paulo
      - POSTGRES_MULTIPLE_DATABASES=chatwoot,atlas_nexa
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh:ro
    networks:
      - nexa_network
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 4096M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: nexa_redis
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      - redis_data:/data
    networks:
      - nexa_network
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1024M
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ==========================================
  # CHATWOOT (White-Label Inbox)
  # ==========================================

  chatwoot_app:
    image: ${CHATWOOT_IMAGE:-nexateam/chatwoot-custom:latest}
    container_name: nexa_chatwoot_app
    command: bundle exec rails s -p 3000 -b 0.0.0.0
    entrypoint: docker/entrypoints/rails.sh
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - chatwoot_storage:/app/storage
    networks:
      - nexa_network
    environment:
      # Installation
      - INSTALLATION_NAME=${CLIENT_NAME:-nexa_inbox}
      - NODE_ENV=production
      - RAILS_ENV=production
      - INSTALLATION_ENV=docker

      # Security
      - SECRET_KEY_BASE=${CHATWOOT_SECRET_KEY}
      - FRONTEND_URL=${CHATWOOT_URL}
      - FORCE_SSL=true
      - ENABLE_ACCOUNT_SIGNUP=false

      # White-Label Branding
      - BRAND_NAME=${BRAND_NAME:-Nexa Inbox}
      - BRAND_LOGO_URL=${BRAND_LOGO_URL}
      - BRAND_PRIMARY_COLOR=${BRAND_PRIMARY_COLOR:-#1f93ff}
      - SUPPORT_EMAIL=${SUPPORT_EMAIL}

      # Database
      - POSTGRES_HOST=postgres
      - POSTGRES_USERNAME=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DATABASE=chatwoot
      - POSTGRES_PORT=5432

      # Redis
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0

      # Locale
      - DEFAULT_LOCALE=pt_BR

      # Storage
      - ACTIVE_STORAGE_SERVICE=local
      - RAILS_LOG_TO_STDOUT=true
      - USE_INBOX_AVATAR_FOR_BOT=true

      # Email (SMTP)
      - MAILER_SENDER_EMAIL=${BRAND_NAME:-Nexa Inbox} <${SMTP_USERNAME}>
      - SMTP_DOMAIN=${SMTP_DOMAIN}
      - SMTP_ADDRESS=${SMTP_ADDRESS}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_AUTHENTICATION=login
      - SMTP_ENABLE_STARTTLS_AUTO=true
      - SMTP_OPENSSL_VERIFY_MODE=peer

    ports:
      - "${CHATWOOT_PORT:-3000}:3000"
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1536M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=nexa_network"
      - "traefik.http.routers.chatwoot.rule=Host(`${CHATWOOT_DOMAIN}`)"
      - "traefik.http.routers.chatwoot.entrypoints=websecure"
      - "traefik.http.routers.chatwoot.tls=true"
      - "traefik.http.routers.chatwoot.tls.certresolver=le"
      - "traefik.http.services.chatwoot.loadbalancer.server.port=3000"

  chatwoot_sidekiq:
    image: ${CHATWOOT_IMAGE:-nexateam/chatwoot-custom:latest}
    container_name: nexa_chatwoot_sidekiq
    command: bundle exec sidekiq -C config/sidekiq.yml
    depends_on:
      - postgres
      - redis
      - chatwoot_app
    volumes:
      - chatwoot_storage:/app/storage
    networks:
      - nexa_network
    environment:
      # Same env as chatwoot_app (DRY via env_file in production)
      - INSTALLATION_NAME=${CLIENT_NAME:-nexa_inbox}
      - NODE_ENV=production
      - RAILS_ENV=production
      - INSTALLATION_ENV=docker
      - SECRET_KEY_BASE=${CHATWOOT_SECRET_KEY}
      - FRONTEND_URL=${CHATWOOT_URL}
      - POSTGRES_HOST=postgres
      - POSTGRES_USERNAME=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DATABASE=chatwoot
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - DEFAULT_LOCALE=pt_BR
      - ACTIVE_STORAGE_SERVICE=local
      - RAILS_LOG_TO_STDOUT=true
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1024M
    restart: unless-stopped

  # ==========================================
  # ATLAS NEXA (AI SDR Agent)
  # ==========================================

  atlas_nexa:
    image: ${ATLAS_IMAGE:-nexateam/atlas-nexa:latest}
    container_name: nexa_atlas_sdr
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - atlas_storage:/app/storage
    networks:
      - nexa_network
    environment:
      # Database (Supabase-compatible connection string)
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/atlas_nexa
      - SUPABASE_URL=http://postgres:5432
      - SUPABASE_KEY=${ATLAS_SUPABASE_KEY}

      # Redis (cache, rate limiting)
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/1

      # AI Services
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}

      # WhatsApp (Evolution API or UAZAPI)
      - WHATSAPP_API_URL=${WHATSAPP_API_URL}
      - WHATSAPP_API_KEY=${WHATSAPP_API_KEY}
      - WHATSAPP_PHONE_ID=${WHATSAPP_PHONE_ID}

      # Integration with Chatwoot
      - CHATWOOT_API_URL=${CHATWOOT_URL}/api/v1
      - CHATWOOT_API_TOKEN=${CHATWOOT_API_TOKEN}
      - CHATWOOT_ACCOUNT_ID=${CHATWOOT_ACCOUNT_ID}
      - CHATWOOT_INBOX_ID=${CHATWOOT_INBOX_ID}

      # N8N Webhooks
      - N8N_WEBHOOK_URL=${N8N_URL}/webhook
      - HANDOFF_WEBHOOK_URL=${N8N_URL}/webhook/atlas-qualified-lead

      # Qualification Settings
      - QUALIFICATION_THRESHOLD=${QUALIFICATION_THRESHOLD:-7}
      - AUTO_HANDOFF_ENABLED=${AUTO_HANDOFF_ENABLED:-true}

    ports:
      - "${ATLAS_PORT:-4000}:4000"
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1024M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.atlas.rule=Host(`${ATLAS_DOMAIN}`)"
      - "traefik.http.routers.atlas.entrypoints=websecure"
      - "traefik.http.routers.atlas.tls=true"
      - "traefik.http.services.atlas.loadbalancer.server.port=4000"

  # ==========================================
  # DASHBOARD (Analytics & Control)
  # ==========================================

  dashboard:
    image: ${DASHBOARD_IMAGE:-nexateam/nexa-dashboard:latest}
    container_name: nexa_dashboard
    depends_on:
      - postgres
      - redis
    networks:
      - nexa_network
    environment:
      # Database connections (read-only for security)
      - CHATWOOT_DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/chatwoot
      - ATLAS_DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/atlas_nexa

      # API access
      - CHATWOOT_API_URL=${CHATWOOT_URL}/api/v1
      - CHATWOOT_API_TOKEN=${CHATWOOT_API_TOKEN}
      - ATLAS_API_URL=http://atlas_nexa:4000

      # Branding
      - BRAND_NAME=${BRAND_NAME}
      - BRAND_LOGO_URL=${BRAND_LOGO_URL}
      - PRIMARY_COLOR=${BRAND_PRIMARY_COLOR}

      # Authentication
      - JWT_SECRET=${DASHBOARD_JWT_SECRET}
      - SESSION_SECRET=${DASHBOARD_SESSION_SECRET}

    ports:
      - "${DASHBOARD_PORT:-5000}:5000"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`${DASHBOARD_DOMAIN}`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.services.dashboard.loadbalancer.server.port=5000"

  # ==========================================
  # N8N (Optional - Workflow Automation)
  # ==========================================

  n8n:
    image: n8nio/n8n:latest
    container_name: nexa_n8n
    depends_on:
      - postgres
      - redis
    networks:
      - nexa_network
    environment:
      - N8N_HOST=${N8N_DOMAIN}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=${N8N_URL}

      # Database (optional, for workflow persistence)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=postgres
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}

      # Encryption
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      # Timezone
      - GENERIC_TIMEZONE=America/Sao_Paulo

    ports:
      - "${N8N_PORT:-5678}:5678"
    volumes:
      - ./n8n-data:/home/node/.n8n
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1024M
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`${N8N_DOMAIN}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"

  # ==========================================
  # TRAEFIK (Reverse Proxy - Optional)
  # ==========================================

  # Uncomment if not using external Traefik
  # traefik:
  #   image: traefik:v2.10
  #   container_name: nexa_traefik
  #   command:
  #     - "--api.dashboard=true"
  #     - "--providers.docker=true"
  #     - "--providers.docker.exposedbydefault=false"
  #     - "--entrypoints.web.address=:80"
  #     - "--entrypoints.websecure.address=:443"
  #     - "--certificatesresolvers.le.acme.httpchallenge=true"
  #     - "--certificatesresolvers.le.acme.httpchallenge.entrypoint=web"
  #     - "--certificatesresolvers.le.acme.email=${ACME_EMAIL}"
  #     - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json"
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #     - "8080:8080"  # Dashboard
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #     - ./letsencrypt:/letsencrypt
  #   networks:
  #     - nexa_network
  #   restart: unless-stopped

# ==========================================
# INITIALIZATION NOTES
# ==========================================

# 1. Create .env file from .env.template
# 2. Run: docker-compose -f docker-compose.nexa-platform.yml up -d
# 3. Initialize Chatwoot database:
#    docker exec -it nexa_chatwoot_app bundle exec rails db:chatwoot_prepare
# 4. Initialize Atlas Nexa database:
#    docker exec -it nexa_atlas_sdr npm run migrate
# 5. Create Chatwoot admin user:
#    docker exec -it nexa_chatwoot_app bundle exec rails db:seed
# 6. Access services:
#    - Chatwoot: https://${CHATWOOT_DOMAIN}
#    - Atlas Nexa: https://${ATLAS_DOMAIN}
#    - Dashboard: https://${DASHBOARD_DOMAIN}
#    - N8N: https://${N8N_DOMAIN}
